import{a as c,y as _,q as O,e as J,i as M,m as L,a5 as Q,p as P,h as V,a4 as x,aA as j,c as w}from"./index-CZ03DXjz.js";import{u as q}from"./device-BMhOYHwV.js";import{u as B}from"./status-D38DFJ6c.js";function X(){const a=c(!_.value);return a.value===!1&&O(()=>{a.value=!0}),{isHydrated:a}}const N=typeof ResizeObserver<"u",I=N===!0?{}:{style:"display:block;position:absolute;top:0;left:0;right:0;bottom:0;height:100%;width:100%;overflow:hidden;pointer-events:none;z-index:-1;",url:"about:blank"},Y=J({name:"QResizeObserver",props:{debounce:{type:[String,Number],default:100}},emits:["resize"],setup(a,{emit:S}){let s=null,o,m={width:-1,height:-1};function r(e){e===!0||a.debounce===0||a.debounce==="0"?u():s===null&&(s=setTimeout(u,a.debounce))}function u(){if(s!==null&&(clearTimeout(s),s=null),o){const{offsetWidth:e,offsetHeight:i}=o;(e!==m.width||i!==m.height)&&(m={width:e,height:i},S("resize",m))}}const{proxy:v}=M();if(v.trigger=r,N===!0){let e;const i=t=>{o=v.$el.parentNode,o?(e=new ResizeObserver(r),e.observe(o),u()):t!==!0&&P(()=>{i(!0)})};return O(()=>{i()}),L(()=>{s!==null&&clearTimeout(s),e!==void 0&&(e.disconnect!==void 0?e.disconnect():o&&e.unobserve(o))}),Q}else{let e=function(){s!==null&&(clearTimeout(s),s=null),l!==void 0&&(l.removeEventListener!==void 0&&l.removeEventListener("resize",r,x.passive),l=void 0)},i=function(){e(),o?.contentDocument&&(l=o.contentDocument.defaultView,l.addEventListener("resize",r,x.passive),u())};const{isHydrated:t}=X();let l;return O(()=>{P(()=>{o=v.$el,o&&i()})}),L(e),()=>{if(t.value===!0)return V("object",{class:"q--avoid-card-border",style:I.style,tabindex:-1,type:"text/html",data:I.url,"aria-hidden":"true",onLoad:i})}}}}),Z=j("telemetry",()=>{const a=q(),S=B(),s=w(()=>a.alpacaHost),o=w(()=>a.socketAPIPort),m=w(()=>`ws://${s.value}:${o.value}/ws`),r=w(()=>u.value==="connected"),u=c("disconnected"),v=c(Date.now()),e=c({}),i=c(new Set),t=c(null),l=c(null),h=c(null),b=c(null),k=c(0);function z(n){const d=n??m.value;d&&(t.value&&l.value!==d&&(console.warn(`Switching WebSocket from ${l.value} to ${d}`),D()),!t.value&&(u.value=n?"connecting":"reconnecting",t.value=new WebSocket(d),l.value=d,t.value.onopen=()=>{u.value="connected",v.value=Date.now(),k.value=0,i.value.forEach(f=>C(f)),$()},t.value.onmessage=f=>{v.value=Date.now();try{const g=JSON.parse(f.data),p=g.topic||g.type;if(p==="pong")return;if(p==="status")S.statusUpdate(g.data);else{e.value[p]||(e.value[p]=[]),e.value[p].push(g);const H=150;e.value[p].length>H&&e.value[p].splice(0,e.value[p].length-H)}}catch(g){console.warn("Invalid telemetry:",g)}},t.value.onerror=f=>{u.value="error",console.error("WebSocket error:",f)},t.value.onclose=f=>{u.value="disconnected",console.warn("WebSocket closed:",f.code,f.reason),y(),R()}))}function R(){if(b.value)return;u.value="reconnecting";const n=Math.min(1e3*Math.pow(2,k.value),1e4);b.value=setTimeout(()=>{b.value=null,k.value++,z()},n)}function D(){u.value="disconnected",y(),b.value&&(clearTimeout(b.value),b.value=null)}function $(){T(),h.value=setInterval(()=>{A(),U()},5e3)}function T(){h.value&&(clearInterval(h.value),h.value=null)}function A(){r.value&&t.value&&t.value.send(JSON.stringify({type:"ping"}))}function U(){Date.now()-v.value>1e4&&(a.isVisible?(console.warn("Socket appears stale, reconnecting..."),y(),R()):y())}function y(){T(),t.value&&(t.value.close(),t.value=null)}function C(n,d={}){i.value.add(n),E(n),r.value&&t.value&&t.value.send(JSON.stringify({type:"subscribe",topic:n,filter:d}))}function W(n){i.value.delete(n),e.value[n]=[],r.value&&t.value&&t.value.send(JSON.stringify({type:"unsubscribe",topic:n}))}function E(n){e.value[n]=[]}return{socketHost:s,socketPort:o,socketURL:m,socketConnected:r,socketConnectionStatus:u,lastActivity:v,topics:e,subscriptions:i,connectSocket:z,disconnectSocket:D,subscribe:C,unsubscribe:W,clear:E}});export{Y as Q,Z as u};
