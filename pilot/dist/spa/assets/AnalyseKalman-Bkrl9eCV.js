import{Q as oe}from"./QSpace-WNZS6s5s.js";import{d as se,a as y,c,w as C,q as ae,z as le,B as ne,E as ie,F as o,I as e,J as r,N as l,M as V,Q as L,G as re,P as f,H as ue}from"./index-CzUz1poz.js";import{Q as de}from"./QBtnToggle-DWVPBQQt.js";import{Q as _,a as d}from"./QItem-CIxyHNF2.js";import{Q as m}from"./QItemLabel-4d6Diaq8.js";import{Q as S}from"./QList-D1nyExqs.js";import{Q as T}from"./QCard-CK4i7p9g.js";import{Q as P}from"./QKnob-Bs_QjC-4.js";import{Q as me}from"./QPage-2ewRn8KR.js";import{u as ce}from"./use-quasar-vHExpJql.js";import{_ as fe}from"./StatusBanners.vue_vue_type_script_setup_true_lang-CCCdilvw.js";import{C as R}from"./ChartXY-ZDJ3rgFB.js";import{u as pe}from"./stream-Dgf0vxLL.js";import{u as _e}from"./config-Dv-6m4Q8.js";import{u as ve}from"./device-BWnNoMeK.js";import{a as ge}from"./scale-WFj20Uim.js";import{_ as E}from"./MoveButton.vue_vue_type_script_setup_true_lang-CPb_bgPh.js";import"./QBtnGroup-CyVg6k59.js";import"./use-dark-CN-7xWWN.js";import"./QCircularProgress-DO6wLJZQ.js";import"./format-BvkBI9bc.js";import"./TouchPan-CynhfbVj.js";import"./touch-BjYP5sR0.js";import"./selection-BBj0YpLT.js";import"./QBanner-gQDwPbxk.js";import"./status-DQXUPgEb.js";import"./index-DaEgsOZv.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./angles-BzRmwPyf.js";const ye={class:"row q-pb-sm q-col-gutter-md items-center"},be={class:"q-gutter-md flex justify-end q-mr-md"},he={class:"col-auto q-gutter-sm flex justify-end items-center"},xe={class:"row q-col-gutter-sm items-stretch"},ke={class:"col-12 flex"},we={class:"row"},Me={class:"col-md-6"},Qe={class:"col-md-6 q-pt-sm"},Ve={class:"q-gutter-ax"},Pe={class:"col-md-6 flex"},Ae={class:"col-md-6 flex"},lt=se({__name:"AnalyseKalman",setup(qe){const K=ce(),p=pe(),u=_e(),A=ve(),a=y(0),b=y(5),h=y(5),x=y(5),k=y(5),g=c(()=>`M${a.value+1}`),$=c(()=>M(b.value)),I=c(()=>Q($.value)),D=c(()=>M(h.value)),N=c(()=>Q(D.value)),F=c(()=>M(x.value)),j=c(()=>Q(F.value)),U=c(()=>M(k.value)),z=c(()=>Q(U.value)),w=s=>Math.log10(s)+6,M=s=>Math.pow(10,-6+s),Q=s=>ge(s,"deg",1),H=c(()=>(p.topics?.kf??[]).map(Y)),G=c(()=>(p.topics?.kf??[]).map(O)),B=c(()=>{const s=p.topics?.kf?.[p.topics.kf.length-1];if(!s)return{pos:"",vel:""};const i=s.data.K_gain;if(Array.isArray(i)&&i.length===6&&a.value>=0&&a.value<3){const n=i[a.value]??0,v=i[a.value+3]??0;return{pos:n.toFixed(2),vel:v.toFixed(2)}}return{pos:"",vel:""}});C([$,D,F,U],s=>{const t={kf_measure_noise:u.kf_measure_noise,kf_process_noise:u.kf_process_noise};t.kf_measure_noise[a.value]=s[0],t.kf_measure_noise[a.value+3]=s[1],t.kf_process_noise[a.value]=s[2],t.kf_process_noise[a.value+3]=s[3],ee(t)}),C(a,()=>q());async function J(s){const t=s.isPressed;await A.apiAction("Polaris:MoveMotor",`{"axis":${a.value},"rate":${t?.017836:0}}`)}async function X(s){const t=s.isPressed;await A.apiAction("Polaris:MoveMotor",`{"axis":${a.value},"rate":${t?-.017836:0}}`)}function q(){const s=a.value??0,t=u.kf_measure_noise[s]??1e-6;b.value=w(t);const i=u.kf_measure_noise[s+3]??1e-6;h.value=w(i);const n=u.kf_process_noise[s]??1e-6;x.value=w(n);const v=u.kf_process_noise[s]??1e-6;k.value=w(v)}function Y(s){const t=new Date(s.ts),i=s.data,n=i.θ_meas[a.value]??0,v=i.θ_state[a.value]??0;return{x1:t,y1:n,y2:v}}function O(s){const t=new Date(s.ts),i=s.data,n=i.ω_meas[a.value]??0,v=i.ω_state[a.value]??0,te=i.ω_ref[a.value]??0;return{x1:t,y1:n,y2:v,y3:te}}ae(async()=>{await u.configFetch(),p.subscribe("kf"),q()}),le(()=>{p.unsubscribe("kf")}),C(()=>A.isVisible,s=>{s?p.subscribe("kf"):p.unsubscribe("kf")});async function W(){const s=await u.configSave();K.notify({message:`Configuration save ${s?"successful":"unsucessful"}.`,type:s?"positive":"negative",position:"top",timeout:3e3,actions:[{icon:"mdi-close",color:"white"}]})}async function Z(){const s=await u.configRestore();K.notify({message:`Configuration restore ${s?"successful":"unsucessful"}.`,type:s?"positive":"negative",position:"top",timeout:3e3,actions:[{icon:"mdi-close",color:"white"}]}),q()}const ee=ne(s=>u.configUpdate(s),500);return(s,t)=>{const i=re("q-markdown");return ue(),ie(me,{class:"q-pa-sm dark-page"},{default:o(()=>[e(fe),r("div",ye,[t[5]||(t[5]=r("div",{class:"col text-h6 q-ml-md"},[l(" Alpaca Driver Performance Analysis "),r("div",{class:"text-caption text-grey-6"}," Use these pages to perform tests and analyse the performance of your Benro Polaris. ")],-1)),e(oe),r("div",be,[r("div",he,[e(L,{rounded:"",color:"grey-9",label:"Save",onClick:W,disable:V(u).isSaving,loading:V(u).isSaving},null,8,["disable","loading"]),e(L,{rounded:"",color:"grey-9",label:"Restore",onClick:Z,disable:V(u).isRestoring,loading:V(u).isRestoring},null,8,["disable","loading"])])])]),r("div",xe,[r("div",ke,[e(T,{flat:"",bordered:"",class:"col q-pa-md"},{default:o(()=>[r("div",we,[r("div",Me,[e(i,{"no-mark":!1},{default:o(()=>t[6]||(t[6]=[l(`
# Kalman Filter Tuning
The purpose of a Kalman Filter (KF) is to estimate the true orientation of the telescope mount. It combines noisy sensor measurements and expected motion to produce the most accurate result possible. 

This page presents the raw sensor data in dark green, the filtered data in yellow, and the control velocity in red. Changes take effect immediately, use Settings Save to store adjustments.
`,-1)])),_:1,__:[6]})]),r("div",Qe,[e(S,null,{default:o(()=>[e(_,null,{default:o(()=>[e(d,{side:"",top:""},{default:o(()=>[e(de,{modelValue:a.value,"onUpdate:modelValue":t[0]||(t[0]=n=>a.value=n),push:"",rounded:"",glossy:"","toggle-color":"primary",options:[{label:"M1",value:0},{label:"M2",value:1},{label:"M3",value:2}]},null,8,["modelValue"])]),_:1}),e(d,null,{default:o(()=>[e(m,null,{default:o(()=>t[7]||(t[7]=[l(" Choosen Motor Axis",-1)])),_:1,__:[7]}),e(m,{caption:""},{default:o(()=>t[8]||(t[8]=[l(" Select the motor axis you'd like to analyse and tune. Motor 1 Azimuth; Motor 2 Altitude; Motor 3 Astro head. Keep in mind: when Motor 3 (Astro Head) is rotated, the orientation of Motor 1 and Motor 2 no longer corresponds directly to Azimuth and Altitude. ",-1)])),_:1,__:[8]})]),_:1})]),_:1}),e(_,{"inset-level":1},{default:o(()=>[e(d,{top:"",side:""},{default:o(()=>[r("div",Ve,[e(E,{activeColor:"positive",icon:"mdi-minus-circle",onPush:X}),e(E,{activeColor:"positive",icon:"mdi-plus-circle",onPush:J})])]),_:1}),e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Test movement of "+f(g.value),1)]),_:1}),e(m,{caption:""},{default:o(()=>t[9]||(t[9]=[l(" Use the following action buttons to move the motor and monitor how the filtered position tracks the raw sensor readings. ",-1)])),_:1,__:[9]})]),_:1})]),_:1})]),_:1})])])]),_:1})]),r("div",Pe,[e(T,{flat:"",bordered:"",class:"col"},{default:o(()=>[e(S,null,{default:o(()=>[e(_,null,{default:o(()=>[e(d,{side:"",top:""},{default:o(()=>[e(P,{modelValue:b.value,"onUpdate:modelValue":t[1]||(t[1]=n=>b.value=n),"show-value":"",min:0,"inner-min":1,"inner-max":6,max:7,step:.1},{default:o(()=>[l(f(I.value),1)]),_:1},8,["modelValue"])]),_:1}),e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Angular Position Measurement Error (R) for "+f(g.value),1)]),_:1}),e(m,{caption:""},{default:o(()=>t[10]||(t[10]=[l(" This defines the expected uncertainty in the measurement of angular position. Larger values means less trust in position measurement, smoother but possibly lagging estimates. ",-1)])),_:1,__:[10]})]),_:1})]),_:1}),e(_,null,{default:o(()=>[e(d,{side:"",top:""},{default:o(()=>[e(P,{modelValue:x.value,"onUpdate:modelValue":t[2]||(t[2]=n=>x.value=n),"show-value":"",min:0,"inner-min":1,"inner-max":6,max:7,step:.1},{default:o(()=>[l(f(j.value),1)]),_:1},8,["modelValue"])]),_:1}),e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Angular Position Process Error (Q) for "+f(g.value),1)]),_:1}),e(m,{caption:""},{default:o(()=>t[11]||(t[11]=[l(" This defines the expected uncertainty in the dynamic process of predicting angular position. Larger values means less trust in position prediction, smoother but possibly lagging estimates. ",-1)])),_:1,__:[11]})]),_:1})]),_:1}),e(_,null,{default:o(()=>[e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Position Measured (K = "+f(B.value.pos)+") and Filtered vs Time ",1)]),_:1})]),_:1})]),_:1})]),_:1}),e(R,{data:H.value,x1Type:"time"},null,8,["data"]),t[12]||(t[12]=r("div",{class:"q-pb-xl"},null,-1))]),_:1,__:[12]})]),r("div",Ae,[e(T,{flat:"",bordered:"",class:"col"},{default:o(()=>[e(S,null,{default:o(()=>[e(_,null,{default:o(()=>[e(d,{side:"",top:""},{default:o(()=>[e(P,{modelValue:h.value,"onUpdate:modelValue":t[3]||(t[3]=n=>h.value=n),"show-value":"",min:0,"inner-min":1,"inner-max":6,max:7,step:.1},{default:o(()=>[l(f(N.value),1)]),_:1},8,["modelValue"])]),_:1}),e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Angular Velocity Measurement Error (R) for "+f(g.value),1)]),_:1}),e(m,{caption:""},{default:o(()=>t[13]||(t[13]=[l(" The defines the expected uncertainty in the measurement of angular velocity. Larger values means less trust in velocity measurement, smoother but possibly lagging estimates. ",-1)])),_:1,__:[13]})]),_:1})]),_:1}),e(_,null,{default:o(()=>[e(d,{side:"",top:""},{default:o(()=>[e(P,{modelValue:k.value,"onUpdate:modelValue":t[4]||(t[4]=n=>k.value=n),"show-value":"",min:0,"inner-min":1,"inner-max":6,max:7,step:.1},{default:o(()=>[l(f(z.value),1)]),_:1},8,["modelValue"])]),_:1}),e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Angular Velocity Process Error (Q) for "+f(g.value),1)]),_:1}),e(m,{caption:""},{default:o(()=>t[14]||(t[14]=[l(" This defines the expected uncertainty in the dynamic process of predicting angular velocity. Larger values means less trust in velocity prediction, smoother but possibly lagging estimates. ",-1)])),_:1,__:[14]})]),_:1})]),_:1})]),_:1}),e(_,null,{default:o(()=>[e(d,null,{default:o(()=>[e(m,null,{default:o(()=>[l(" Velocity Measured (K = "+f(B.value.vel)+") and Filtered vs Time ",1)]),_:1})]),_:1})]),_:1}),e(R,{data:G.value,x1Type:"time"},null,8,["data"]),t[15]||(t[15]=r("div",{class:"q-pb-xl"},null,-1))]),_:1,__:[15]})])])]),_:1})}}});export{lt as default};
