import{az as W,c as S,a as o}from"./index-CzUz1poz.js";import{u as $}from"./device-BWnNoMeK.js";import{u as M}from"./status-DQXUPgEb.js";const L=W("telemetry",()=>{const g=$(),R=M(),w=S(()=>g.alpacaHost),b=S(()=>g.socketAPIPort),y=S(()=>`ws://${w.value}:${b.value}/ws`),i=S(()=>a.value==="connected"),a=o("disconnected"),v=o(Date.now()),n=o({}),f=o(new Set),e=o(null),m=o(null),d=o(null),s=o(null),k=o(0);function h(t){const c=t??y.value;c&&(e.value&&m.value!==c&&(console.warn(`Switching WebSocket from ${m.value} to ${c}`),C()),!e.value&&(a.value=t?"connecting":"reconnecting",e.value=new WebSocket(c),m.value=c,e.value.onopen=()=>{a.value="connected",v.value=Date.now(),k.value=0,f.value.forEach(u=>O(u)),_()},e.value.onmessage=u=>{v.value=Date.now();try{const r=JSON.parse(u.data),l=r.topic||r.type;if(l==="pong")return;if(l==="status")R.statusUpdate(r.data);else{n.value[l]||(n.value[l]=[]),n.value[l].push(r);const P=200;n.value[l].length>P&&n.value[l].splice(0,n.value[l].length-P)}}catch(r){console.warn("Invalid telemetry:",r)}},e.value.onerror=u=>{a.value="error",console.error("WebSocket error:",u)},e.value.onclose=u=>{a.value="disconnected",console.warn("WebSocket closed:",u.code,u.reason),p(),D()}))}function D(){if(s.value)return;a.value="reconnecting";const t=Math.min(1e3*Math.pow(2,k.value),1e4);s.value=setTimeout(()=>{s.value=null,k.value++,h()},t)}function C(){a.value="disconnected",p(),s.value&&(clearTimeout(s.value),s.value=null)}function _(){I(),d.value=setInterval(()=>{A(),J()},5e3)}function I(){d.value&&(clearInterval(d.value),d.value=null)}function A(){i.value&&e.value&&e.value.send(JSON.stringify({type:"ping"}))}function J(){Date.now()-v.value>1e4&&(g.isVisible?(console.warn("Socket appears stale, reconnecting..."),p(),D()):p())}function p(){I(),e.value&&(e.value.close(),e.value=null)}function O(t,c={}){f.value.add(t),i.value&&e.value&&e.value.send(JSON.stringify({type:"subscribe",topic:t,filter:c}))}function N(t){f.value.delete(t),n.value[t]=[],i.value&&e.value&&e.value.send(JSON.stringify({type:"unsubscribe",topic:t}))}function U(t){n.value[t]=[]}return{socketHost:w,socketPort:b,socketURL:y,socketConnected:i,socketConnectionStatus:a,lastActivity:v,topics:n,subscriptions:f,connectSocket:h,disconnectSocket:C,subscribe:O,unsubscribe:N,clear:U}});export{L as u};
